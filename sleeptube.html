<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor de Listas M3U & Multiplataforma</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 100%;
        }
        #player {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #000;
            margin-bottom: 10px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }
        button {
            padding: 8px 12px;
            background-color: #ff0000;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #cc0000;
        }
        .delete-btn {
            background-color: #757575;
        }
        .delete-btn:hover {
            background-color: #c62828;
        }
        .move-btn {
            background-color: #607d8b;
            margin-left: 3px;
            margin-right: 3px;
        }
        .move-btn:hover {
            background-color: #37474f;
        }
        .cast-btn {
            background-color: #2196f3;
            margin-left: 3px;
            margin-right: 3px;
        }
        .cast-btn:hover {
            background-color: #1769aa;
        }
        .cineupdate-btn {
            background-color: #9c27b0;
            margin-left: 3px;
            margin-right: 3px;
        }
        .cineupdate-btn:hover {
            background-color: #7b1fa2;
        }
        .urllink-btn {
            background-color: #4caf50;
            margin-left: 3px;
            margin-right: 3px;
        }
        .urllink-btn:hover {
            background-color: #388e3c;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: vertical;
        }
        .url-list {
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
        .url-list-content {
            display: flex;
            flex-direction: column;
        }
        .url-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            background: none;
        }
        .url-item:hover {
            background-color: #f0f0f0;
        }
        .url-item.active {
    background-color: #4CAF50; /* Verde */
    font-weight: bold;
    color: white; /* Texto blanco para mejor contraste */
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 8px 12px;
            background-color: #4285f4;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            margin: 5px 0;
        }
        .status {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin: 5px 0;
        }
        .timer-active {
            background-color: #ffa726 !important;
            color: #333 !important;
        }
        .move-btn[disabled] {
            opacity: 0.4;
            cursor: default;
        }
        .m3u-fields {
            font-size: 0.85em;
            color: #555;
            margin-left: 8px;
            margin-bottom: 2px;
        }
    </style>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <div id="player"></div>
        <div class="controls">
            <button id="playBtn">Play</button>
            <button id="pauseBtn">Pausa</button>
            <button id="stopBtn">Stop</button>
            <button id="nextBtn">Siguiente</button>
            <button id="prevBtn">Anterior</button>
            <button id="skipAdBtn">Saltar Publicidad</button>
            <button id="timerBtn">Temporizador</button>
            <button id="deleteBtn" class="delete-btn">Eliminar seleccionado</button>
            <button id="castBtn" class="cast-btn">Enviar a Chromecast</button>
            <button id="cineupdateBtn" class="cineupdate-btn">CineUpdate</button>
            <button id="urlLinkBtn" class="urllink-btn">URL link</button>
        </div>
        <div class="status" id="status">Estado: Listo</div>
        <textarea id="urlInput" placeholder="Introduce URLs/M3U/M3U8, una por línea, o pega el contenido M3U"></textarea>
        <input type="text" id="videoTitle" placeholder="Título del video (opcional)" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;">
        <div class="controls">
            <button id="addBtn">Añadir a lista</button>
            <button id="clearBtn">Limpiar lista</button>
        </div>
        <label for="fileInput" class="file-label">Cargar archivo local</label>
        <input type="file" id="fileInput" class="file-input" accept=".m3u,.m3u8,.txt,.json">
        <button id="saveFileBtn">Guardar lista en dispositivo</button>
        <button id="exportM3UBtn">Exportar como M3U</button>
        <div class="url-list">
            <div class="url-list-content" id="urlList"></div>
        </div>
    </div>
    <script>
        let currentVideoIndex = -1;
        let playlist = [];
        let adInterval;
        let isAdPlaying = false;
        let timerTimeout = null;
        let timerEndTimestamp = null;
        let playerType = null;
        let player = null;
        let playerIframe = null;
        let castSession = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadPlaylistFromStorage();
            updateUrlListDisplay();
            setInterval(updateTimerStatus, 1000);

            document.getElementById('playBtn').addEventListener('click', function() {
                if (currentVideoIndex === -1 && playlist.length > 0) {
                    playVideo(0);
                } else if (playerType) {
                    resumePlayer();
                }
            });

            document.getElementById('pauseBtn').addEventListener('click', pausePlayer);

            document.getElementById('stopBtn').addEventListener('click', function() {
                stopPlayer();
                if (timerTimeout) {
                    clearTimeout(timerTimeout);
                    timerTimeout = null;
                    timerEndTimestamp = null;
                    document.getElementById('timerBtn').classList.remove('timer-active');
                    document.getElementById('timerBtn').textContent = 'Temporizador';
                }
            });

            document.getElementById('nextBtn').addEventListener('click', playNextVideo);
            document.getElementById('prevBtn').addEventListener('click', playPreviousVideo);
            document.getElementById('skipAdBtn').addEventListener('click', skipAd);
            document.getElementById('timerBtn').addEventListener('click', toggleTimer);
            document.getElementById('deleteBtn').addEventListener('click', function() {
                if (currentVideoIndex >= 0 && currentVideoIndex < playlist.length) {
                    playlist.splice(currentVideoIndex, 1);
                    if (currentVideoIndex >= playlist.length) currentVideoIndex = playlist.length - 1;
                    savePlaylistToStorage();
                    updateUrlListDisplay();
                    updateStatus('Elemento eliminado');
                }
            });

            document.getElementById('castBtn').addEventListener('click', async function() {
    try {
        const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
        
        if (!castSession) {
            await cast.framework.CastContext.getInstance().requestSession();
            return;
        }
        
        if (currentVideoIndex < 0 || currentVideoIndex >= playlist.length) {
            updateStatus('No hay video para transmitir');
            return;
        }
        
        const currentItem = playlist[currentVideoIndex];
        
        if (isDailymotionUrl(currentItem.url)) {
            const videoId = currentItem.url.match(/dailymotion\.com\/video\/([a-zA-Z0-9]+)/)[1];
            const castUrl = `https://www.dailymotion.com/embed/video/${videoId}?autoplay=1`;
            
            const mediaInfo = new chrome.cast.media.MediaInfo(
                castUrl,
                'video/mp4'
            );
            
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = currentItem.title || "Video Dailymotion";
            mediaInfo.streamType = chrome.cast.media.StreamType.BUFFERED;
            mediaInfo.contentType = 'video/mp4';
            
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;
            
            castSession.loadMedia(request).then(
                function() { updateStatus('Transmitiendo Dailymotion a Chromecast'); },
                function(error) { updateStatus('Error: ' + error.description); }
            );
        } else {
            const mediaInfo = new chrome.cast.media.MediaInfo(
                currentItem.url,
                getContentType(currentItem.url)
            );
            
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = currentItem.title || "Video sin título";
            mediaInfo.streamType = chrome.cast.media.StreamType.BUFFERED;
            
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;
            
            castSession.loadMedia(request).then(
                function() { updateStatus('Transmitiendo a Chromecast'); },
                function(error) { updateStatus('Error: ' + error.description); }
            );
        }
    } catch (error) {
        updateStatus('Error Chromecast: ' + error.message);
    }
});

            document.getElementById('cineupdateBtn').addEventListener('click', function() {
                // Código para CineUpdate (se completa en siguiente parte)
            });

            document.getElementById('urlLinkBtn').addEventListener('click', function() {
                // Código para URL Link (se completa en siguiente parte)
            });

            document.getElementById('addBtn').addEventListener('click', function() {
                // Código para añadir a lista (se completa en siguiente parte)
            });

            document.getElementById('clearBtn').addEventListener('click', function() {
                playlist = [];
                currentVideoIndex = -1;
                savePlaylistToStorage();
                updateUrlListDisplay();
                updateStatus('Lista borrada');
            });

            document.getElementById('saveFileBtn').addEventListener('click', function() {
                const dataStr = JSON.stringify(playlist, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'playlist.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });

            document.getElementById('exportM3UBtn').addEventListener('click', function() {
                const m3uContent = exportAsM3U(playlist);
                const dataUri = 'data:application/octet-stream;charset=utf-8,'+ encodeURIComponent(m3uContent);
                const exportFileDefaultName = 'playlist.m3u';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (file.name.toLowerCase().endsWith('.json')) {
                        try {
                            const data = JSON.parse(content);
                            if (Array.isArray(data)) {
                                playlist = data;
                                currentVideoIndex = -1;
                                savePlaylistToStorage();
                                updateUrlListDisplay();
                                updateStatus('Lista cargada desde JSON');
                            }
                        } catch (error) {
                            updateStatus('Error al leer archivo JSON');
                        }
                    } else {
                        const parsedList = parseM3U(content);
                        if (parsedList.length > 0) {
                            playlist = parsedList;
                            currentVideoIndex = -1;
                            savePlaylistToStorage();
                            updateUrlListDisplay();
                            updateStatus('Lista cargada desde M3U');
                        }
                    }
                };
                reader.readAsText(file);
            });

            if (window.chrome && window.cast && window.cast.framework) {
                initializeCastApi();
            } else {
                window['__onGCastApiAvailable'] = function(isAvailable) {
                    if (isAvailable) {
                        initializeCastApi();
                    }
                };
            }
        });

        function isHlsStream(url) {
            if (!url) return false;
            const lowerUrl = url.toLowerCase();
            return lowerUrl.endsWith('.m3u8') || 
                lowerUrl.includes('.m3u8?') ||
                lowerUrl.includes('m3u8') ||
                lowerUrl.includes('application/vnd.apple.mpegurl') ||
                lowerUrl.includes('hls');
        }

        function stopPlayer() {
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = '';
            if (playerType === 'hls' && player && typeof player.destroy === 'function') {
                player.destroy();
            }
            playerType = null;
            player = null;
            playerIframe = null;
        }

        function pausePlayer() {
            if (playerType === 'youtube' && player) {
                player.pauseVideo();
            } else if (playerType === 'dailymotion' && playerIframe) {
                playerIframe.contentWindow.postMessage({ command: 'pause' }, '*');
            } else if (playerType === 'okru' && playerIframe) {
                playerIframe.contentWindow.postMessage('video:pause', '*');
            } else if (playerType === 'hls') {
                const video = document.getElementById('hls-video');
                if (video) video.pause();
            }
        }

        function resumePlayer() {
            if (playerType === 'youtube' && player) {
                player.playVideo();
            } else if (playerType === 'dailymotion' && playerIframe) {
                playerIframe.contentWindow.postMessage({ command: 'play' }, '*');
            } else if (playerType === 'okru' && playerIframe) {
                playerIframe.contentWindow.postMessage('video:play', '*');
            } else if (playerType === 'hls') {
                const video = document.getElementById('hls-video');
                if (video) video.play().catch(e => console.error('Error al reproducir:', e));
            }
        }

        function toggleTimer() {
            if (timerTimeout) {
                clearTimeout(timerTimeout);
                timerTimeout = null;
                timerEndTimestamp = null;
                document.getElementById('timerBtn').classList.remove('timer-active');
                updateStatus('Temporizador cancelado');
            } else {
                const minutes = prompt('¿Cuántos minutos para el temporizador?');
                if (minutes && !isNaN(minutes) && minutes > 0) {
                    const milliseconds = minutes * 60 * 1000;
                    timerEndTimestamp = Date.now() + milliseconds;
                    timerTimeout = setTimeout(function() {
                        stopPlayer();
                        updateStatus('Temporizador finalizado - Reproducción detenida');
                        document.getElementById('timerBtn').classList.remove('timer-active');
                        timerTimeout = null;
                        timerEndTimestamp = null;
                    }, milliseconds);
                    document.getElementById('timerBtn').classList.add('timer-active');
                    updateStatus(`Temporizador activado: ${minutes} minuto(s)`);
                }
            }
        }
                function playNextVideo() {
            if (playlist.length === 0) return;
            const nextIndex = currentVideoIndex + 1;
            if (nextIndex < playlist.length) {
                playVideo(nextIndex);
            } else {
                updateStatus('Fin de la lista de reproducción');
                currentVideoIndex = -1;
                highlightCurrentVideo();
                stopPlayer();
            }
        }

        function playPreviousVideo() {
            if (playlist.length === 0 || currentVideoIndex <= 0) return;
            playVideo(currentVideoIndex - 1);
        }

        function playVideo(index) {
    if (index < 0 || index >= playlist.length) return;
    currentVideoIndex = index;
    const entry = playlist[index];
    stopPlayer();
    const playerDiv = document.getElementById('player');
    let embedUrl = '';
    
    if (isYoutubeUrl(entry.url)) {
        playerType = 'youtube';
        if (!window.YT || !window.YT.Player) {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.body.appendChild(tag);
            window.onYouTubeIframeAPIReady = function() {
                loadYoutubeVideo(entry.url, entry.title);
            };
        } else {
            loadYoutubeVideo(entry.url, entry.title);
        }
    } else if (isDailymotionUrl(entry.url)) {
        playerType = 'dailymotion';
        embedUrl = getDailymotionEmbedUrl(entry.url);
        playerDiv.innerHTML = `<iframe id="dailymotion-iframe" src="${embedUrl}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
        playerIframe = document.getElementById('dailymotion-iframe');
        updateStatus(`Reproduciendo (Dailymotion): ${entry.title || "desconocido"}`);
        
    } 
    else if (isOkruUrl(entry.url)) {
        playerType = 'okru';
        
        // Si ya es una URL de embed, úsala directamente
        if (entry.url.includes('/videoembed/')) {
            embedUrl = entry.url;
        } 
        // Si es una URL normal de video, conviértela a embed
        else if (entry.url.includes('/video/')) {
            const videoId = entry.url.split('/video/')[1].split(/[/?&#]/)[0];
            embedUrl = `https://ok.ru/videoembed/${videoId}?autoplay=1`;
        } 
        // Si no coincide con ningún patrón conocido, usa la URL tal cual
        else {
            embedUrl = entry.url;
        }
        
        playerDiv.innerHTML = `<iframe id="okru-iframe" src="${embedUrl}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay"></iframe>`;
        playerIframe = document.getElementById('okru-iframe');
        updateStatus(`Reproduciendo (OK.ru): ${entry.title || "desconocido"}`);
    } 
else if (isHlsStream(entry.url)) {
        playerType = 'hls';
        playHlsStream(entry.url, entry.title);
        return;
    } else {
        updateStatus('Enlace no soportado');
        stopPlayer();
        return;
    }
    highlightCurrentVideo();
}





        function loadYoutubeVideo(url, title) {
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = `<div id="ytplayer"></div>`;
            const videoId = extractYoutubeId(url);
            const isShort = url.includes('youtube.com/shorts/');
            const playerVars = isShort ? {
                playerVars: {
                    'playsinline': 1,
                    'rel': 0,
                    'modestbranding': 1
                }
            } : {};
            player = new YT.Player('ytplayer', {
                width: '100%',
                height: '100%',
                videoId: videoId,
                ...playerVars,
                events: {
                    'onReady': function() {
                        updateStatus(`Reproduciendo (YouTube${isShort ? ' Shorts' : ''}): ${title || "desconocido"}`);
                        player.playVideo();
                    },
                    'onStateChange': function(event) {
                        if (event.data === YT.PlayerState.ENDED) playNextVideo();
                    }
                }
            });
        }

        function skipAd() {
            if (isAdPlaying) {
                clearTimeout(adInterval);
                isAdPlaying = false;
                updateStatus('Anuncio saltado');
                resumePlayer();
            }
        }

        function parseM3U(content) {
            const lines = content.split(/\r?\n/).map(l => l.trim());
            const entries = [];
            let currentMeta = {};
            for (let i = 0; i < lines.length; ++i) {
                const line = lines[i];
                if (line.startsWith('#EXTINF:')) {
                    const meta = {};
                    const metaMatch = line.match(/tvg-id="([^"]*)"/);
                    if (metaMatch) meta.tvgId = metaMatch[1];
                    const nameMatch = line.match(/tvg-name="([^"]*)"/);
                    if (nameMatch) meta.tvgName = nameMatch[1];
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    if (logoMatch) meta.tvgLogo = logoMatch[1];
                    const groupMatch = line.match(/group-title="([^"]*)"/);
                    if (groupMatch) meta.groupTitle = groupMatch[1];
                    const afterComma = line.split(',').pop().trim();
                    meta.title = afterComma || meta.tvgName || "desconocido";
                    currentMeta = meta;
                } else if (line && !line.startsWith('#')) {
                    entries.push({
                        ...currentMeta,
                        url: line
                    });
                    currentMeta = {};
                }
            }
            return entries.filter(e => e.url);
        }

        function exportAsM3U(list) {
            let m3u = '#EXTM3U\n';
            for (const entry of list) {
                m3u += `#EXTINF:-1`;
                if (entry.tvgId) m3u += ` tvg-id="${entry.tvgId}"`;
                if (entry.tvgName) m3u += ` tvg-name="${entry.tvgName}"`;
                if (entry.tvgLogo) m3u += ` tvg-logo="${entry.tvgLogo}"`;
                if (entry.groupTitle) m3u += ` group-title="${entry.groupTitle}"`;
                m3u += `,${entry.title || entry.tvgName || "desconocido"}\n`;
                m3u += `${entry.url}\n`;
            }
            return m3u;
        }

        function parseUrlOrM3UEntry(line) {
            if (!line) return null;
            if (line.includes('|')) {
                const parts = line.split('|');
                return {
                    url: parts[0].trim(),
                    title: (parts.slice(1).join('|').trim() || "desconocido")
                };
            }
            if (line.startsWith('http')) {
                return { title: "desconocido", url: line };
            }
            return null;
        }

        function savePlaylistToStorage() {
            localStorage.setItem('playlistMulti', JSON.stringify(playlist));
        }

        function loadPlaylistFromStorage() {
            const saved = localStorage.getItem('playlistMulti');
            if (saved) {
                try {
                    playlist = JSON.parse(saved);
                } catch { playlist = []; }
            }
        }

        function isYoutubeUrl(url) {
            return /(youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/shorts\/)/.test(url);
        }

        function isDailymotionUrl(url) {
            return /dailymotion\.com\/video\//.test(url);
        }

        function isOkruUrl(url) {
            return /ok\.ru\/(video|videoembed)\//.test(url);
        }

        function extractYoutubeId(url) {
            if (url.includes('youtube.com/shorts/')) {
                const match = url.match(/youtube\.com\/shorts\/([^#&?]*)/);
                return (match && match[1]) ? match[1] : null;
            }
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function getDailymotionEmbedUrl(url) {
            const match = url.match(/dailymotion.com\/video\/([a-zA-Z0-9]+)/);
            if (match) return `https://www.dailymotion.com/embed/video/${match[1]}?autoplay=1`;
            return url;
        }

        function getOkruEmbedUrl(url) {
            return url.replace('/video/', '/videoembed/');
        }

        function playHlsStream(url, title) {
            const playerDiv = document.getElementById('player');
            playerDiv.innerHTML = '<video id="hls-video" controls width="100%" height="100%"></video>';
            const video = document.getElementById('hls-video');
            if (Hls.isSupported()) {
                const hls = new Hls({
                    debug: false,
                    maxBufferLength: 30,
                    backBufferLength: 30
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    video.play()
                        .then(() => {
                            updateStatus(`Reproduciendo stream HLS: ${title || "desconocido"}`);
                        })
                        .catch(error => {
                            updateStatus('Error al reproducir: ' + error.message);
                        });
                });
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                updateStatus('Error de red en stream HLS');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                updateStatus('Error de medio en stream HLS');
                                hls.recoverMediaError();
                                break;
                            default:
                                hls.destroy();
                                updateStatus('Error fatal en stream HLS');
                                break;
                        }
                    }
                });
                player = hls;
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.addEventListener('loadedmetadata', function() {
                    video.play()
                        .then(() => {
                            updateStatus(`Reproduciendo stream HLS (nativo): ${title || "desconocido"}`);
                        })
                        .catch(error => {
                            updateStatus('Error al reproducir: ' + error.message);
                        });
                });
            } else {
                updateStatus('Tu navegador no soporta reproducción HLS');
            }
        }
                function moveVideo(index, direction) {
            if (direction === 'up' && index > 0) {
                [playlist[index], playlist[index - 1]] = [playlist[index - 1], playlist[index]];
                if (currentVideoIndex === index) currentVideoIndex--;
                else if (currentVideoIndex === index - 1) currentVideoIndex++;
                savePlaylistToStorage();
                updateUrlListDisplay();
                highlightCurrentVideo();
            }
            if (direction === 'down' && index < playlist.length - 1) {
                [playlist[index], playlist[index + 1]] = [playlist[index + 1], playlist[index]];
                if (currentVideoIndex === index) currentVideoIndex++;
                else if (currentVideoIndex === index + 1) currentVideoIndex--;
                savePlaylistToStorage();
                updateUrlListDisplay();
                highlightCurrentVideo();
            }
        }

        function updateUrlListDisplay() {
            const urlListElement = document.getElementById('urlList');
            urlListElement.innerHTML = '';
            if (playlist.length === 0) {
                urlListElement.innerHTML = '<div class="url-item">No hay videos en la lista</div>';
                return;
            }
            playlist.forEach((item, index) => {
                const urlElement = document.createElement('div');
                urlElement.className = 'url-item' + (index === currentVideoIndex ? ' active' : '');
                urlElement.title = item.url;
                const upBtn = document.createElement('button');
                upBtn.textContent = '↑';
                upBtn.className = 'move-btn';
                upBtn.disabled = index === 0;
                upBtn.title = 'Mover arriba';
                upBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    moveVideo(index, 'up');
                });
                const downBtn = document.createElement('button');
                downBtn.textContent = '↓';
                downBtn.className = 'move-btn';
                downBtn.disabled = index === playlist.length - 1;
                downBtn.title = 'Mover abajo';
                downBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    moveVideo(index, 'down');
                });
                const text = document.createElement('span');
                text.textContent = `${index + 1}. ${item.title || item.tvgName || "desconocido"}`;
                text.style.flex = '1';
                urlElement.appendChild(upBtn);
                urlElement.appendChild(downBtn);
                urlElement.appendChild(text);
                if (item.groupTitle || item.tvgName || item.tvgId) {
                    const meta = document.createElement('div');
                    meta.className = 'm3u-fields';
                    meta.textContent = [
                        item.groupTitle ? `Grupo: ${item.groupTitle}` : '',
                        item.tvgName ? `Nombre: ${item.tvgName}` : '',
                        item.tvgId ? `ID: ${item.tvgId}` : ''
                    ].filter(Boolean).join(' | ');
                    urlElement.appendChild(meta);
                }
                urlElement.addEventListener('click', () => playVideo(index));
                urlListElement.appendChild(urlElement);
            });
        }

        function highlightCurrentVideo() {
            const items = document.querySelectorAll('.url-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === currentVideoIndex);
            });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = `Estado: ${message}`;
        }

        function updateTimerStatus() {
            if (timerEndTimestamp) {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((timerEndTimestamp - now) / 1000));
                document.getElementById('timerBtn').textContent = `Temporizador (${remaining}s)`;
                if (remaining <= 0) {
                    document.getElementById('timerBtn').textContent = 'Temporizador';
                    timerEndTimestamp = null;
                }
            } else {
                document.getElementById('timerBtn').textContent = 'Temporizador';
            }
        }

        // Ejemplo de implementación para añadir a lista (puedes ajustar según lógica)
        document.getElementById('addBtn').addEventListener('click', function() {
            const input = document.getElementById('urlInput').value.trim();
            const titleInput = document.getElementById('videoTitle').value.trim();
            if (!input) return;
            let added = false;

            if (input.startsWith('#EXTM3U') || input.includes('#EXTINF')) {
                const entries = parseM3U(input);
                if (entries.length > 0) {
                    playlist = playlist.concat(entries);
                    added = true;
                }
            } else {
                const lines = input.split(/\r?\n/);
                lines.forEach(line => {
                    const entry = parseUrlOrM3UEntry(line);
                    if (entry) {
                        if (titleInput) entry.title = titleInput;
                        playlist.push(entry);
                        added = true;
                    }
                });
            }

            if (added) {
                savePlaylistToStorage();
                updateUrlListDisplay();
                document.getElementById('urlInput').value = '';
                document.getElementById('videoTitle').value = '';
                updateStatus('Añadido(s) a la lista');
            }
        });

        // Ejemplo de implementación de CineUpdate, URL Link y Chromecast
        document.getElementById('urlLinkBtn').addEventListener('click', function() {
            if (currentVideoIndex >= 0 && playlist[currentVideoIndex]) {
                window.open(playlist[currentVideoIndex].url, '_blank');
            }
        });



        document.getElementById('cineupdateBtn').addEventListener('click', function() {
    fetch('https://yagopc.github.io/Cine/doctv.m3u')
        .then(response => response.text())
        .then(content => {
            const entries = parseM3U(content);
            if (entries.length > 0) {
                playlist = playlist.concat(entries);
                savePlaylistToStorage();
                updateUrlListDisplay();
                updateStatus('Lista cargada desde CineUpdate');
            } else {
                updateStatus('No se encontraron entradas válidas en CineUpdate');
            }
        })
        .catch(error => {
            updateStatus('Error al cargar CineUpdate: ' + error.message);
        });
});



        function initializeCastApi() {
    const context = cast.framework.CastContext.getInstance();
    const options = {
        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
    };
    context.setOptions(options);
    
    cast.framework.CastContext.getInstance().addEventListener(
        cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
        function(event) {
            if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
                updateStatus('Conexión Chromecast finalizada');
            } else if (event.sessionState === cast.framework.SessionState.SESSION_CONNECTED) {
                updateStatus('Conectado a Chromecast');
                castSession = context.getCurrentSession();
            }
        }
    );
}

document.getElementById('castBtn').addEventListener('click', async function() {
    try {
        const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
        
        if (!castSession) {
            await cast.framework.CastContext.getInstance().requestSession();
            return;
        }
        
        if (currentVideoIndex < 0 || currentVideoIndex >= playlist.length) {
            updateStatus('No hay video para transmitir');
            return;
        }
        
        const mediaInfo = new chrome.cast.media.MediaInfo(
            playlist[currentVideoIndex].url,
            getContentType(playlist[currentVideoIndex].url)
        );
        
        mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
        mediaInfo.metadata.title = playlist[currentVideoIndex].title || "Video sin título";
        
        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        request.autoplay = true;
        
        castSession.loadMedia(request).then(
            function() { updateStatus('Transmitiendo a Chromecast'); },
            function(error) { updateStatus('Error al transmitir: ' + error.description); }
        );
    } catch (error) {
        updateStatus('Error Chromecast: ' + error.message);
    }
});
function getContentType(url) {
    if (isYoutubeUrl(url)) return 'video/youtube';
    if (isDailymotionUrl(url)) return 'video/mp4';
    if (isOkruUrl(url)) return 'video/mp4';
    if (isHlsStream(url)) return 'application/x-mpegURL';
    return 'video/mp4';
}

document.getElementById('castBtn').addEventListener('click', async function() {
    try {
        const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
        
        if (!castSession) {
            await cast.framework.CastContext.getInstance().requestSession();
            return;
        }
        
        if (currentVideoIndex < 0 || currentVideoIndex >= playlist.length) {
            updateStatus('No hay video para transmitir');
            return;
        }
        
        const currentItem = playlist[currentVideoIndex];
        let mediaUrl = currentItem.url;
        
        if (isDailymotionUrl(mediaUrl)) {
            mediaUrl = getDailymotionEmbedUrl(mediaUrl);
        } else if (isOkruUrl(mediaUrl)) {
            mediaUrl = getOkruEmbedUrl(mediaUrl);
        }
        
        const mediaInfo = new chrome.cast.media.MediaInfo(
            mediaUrl,
            getContentType(mediaUrl)
        );
        
        mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
        mediaInfo.metadata.title = currentItem.title || "Video sin título";
        mediaInfo.contentType = getContentType(mediaUrl);
        
        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        request.autoplay = true;
        
        castSession.loadMedia(request).then(
            function() { updateStatus('Transmitiendo a Chromecast'); },
            function(error) { updateStatus('Error al transmitir: ' + error.description); }
        );
    } catch (error) {
        updateStatus('Error Chromecast: ' + error.message);
    }
});

    </script>
</body>
</html>
